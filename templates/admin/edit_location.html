{% extends "base.html" %}
{% block title %}Admin | Edit Location{% endblock %}

{% block content %}
<div class="admin-container">
  <h1>Edit Location: {{ location.name }}</h1>

  <form method="POST">
    <div class="form-group">
      <label>ID</label>
      <input type="text" class="form-control" value="{{ location.id }}" disabled>
      <small class="text-muted">ID cannot be changed.</small>
    </div>

    <div class="form-group">
      <label for="name">Name</label>
      <input type="text" name="name" id="name" class="form-control"
             value="{{ location.name }}" required>
    </div>

    <div class="form-group">
      <label for="description">Description</label>
      <textarea name="description" id="description" rows="4"
                class="form-control">{{ location.description or '' }}</textarea>
    </div>

    <div class="form-group">
      <label for="themes">Themes (comma-separated)</label>
      <input type="text" name="themes" id="themes" class="form-control"
             value="{{ themes_text }}">
    </div>

    <hr>

    <h3>Location on Map</h3>
    <p>Click on the map to set the latitude and longitude.</p>

    <div id="location-map" style="height: 300px; margin-bottom: 1rem;"></div>

    <div class="form-group">
      <label for="lat">Latitude</label>
      <input type="text" name="lat" id="lat" class="form-control"
             value="{{ location.lat if location.lat is not none else '' }}">
    </div>

    <div class="form-group">
      <label for="lon">Longitude</label>
      <input type="text" name="lon" id="lon" class="form-control"
             value="{{ location.lon if location.lon is not none else '' }}">
    </div>

    <button type="button" id="update-map" class="btn btn-secondary" style="margin-bottom: 1rem;">
      Update Map from Lat/Lon
    </button>

    <div>
      <button type="submit" class="btn btn-primary">Save Changes</button>
      <a href="{{ url_for('admin.admin_locations') }}" class="btn btn-secondary">Cancel</a>
    </div>
  </form>
</div>

<script>
  const defaultLat = 53.3498;
  const defaultLon = -6.2603;

  const existingLat = {{ location.lat if location.lat is not none else 'null' }};
  const existingLon = {{ location.lon if location.lon is not none else 'null' }};

  const startLat = existingLat !== null ? existingLat : defaultLat;
  const startLon = existingLon !== null ? existingLon : defaultLon;

  const map = L.map('location-map').setView([startLat, startLon], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  let marker = null;

  function setMarkerAndInputs(lat, lon) {
    if (marker) {
      marker.setLatLng([lat, lon]);
    } else {
      marker = L.marker([lat, lon]).addTo(map);
    }
    document.getElementById('lat').value = lat.toFixed(6);
    document.getElementById('lon').value = lon.toFixed(6);
  }

  // If we already have coordinates, show marker
  if (existingLat !== null && existingLon !== null) {
    setMarkerAndInputs(existingLat, existingLon);
  }

  map.on('click', function(e) {
    const lat = e.latlng.lat;
    const lon = e.latlng.lng;
    setMarkerAndInputs(lat, lon);
  });

  document.getElementById('update-map').addEventListener('click', function() {
    const latVal = parseFloat(document.getElementById('lat').value);
    const lonVal = parseFloat(document.getElementById('lon').value);
    if (!isNaN(latVal) && !isNaN(lonVal)) {
      setMarkerAndInputs(latVal, lonVal);
      map.setView([latVal, lonVal], 15);
    }
  });
</script>
{% endblock %}
